<!DOCTYPE html>
<html>
  <head>
    <title>Semantic Document Search</title>
    <style>
      /* Main layout styles */
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      /* Section styles */
      .section {
        margin: 30px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fafafa;
      }

      .section h2 {
        color: #555;
        margin-top: 0;
      }

      /* Form input styles */
      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }

      /* Button styles */
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      /* Results display styles */
      .results {
        margin-top: 20px;
      }

      .result-item {
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #eee;
        border-radius: 5px;
        background-color: #f9f9f9;
      }

      .result-item h4 {
        margin-top: 0;
        color: #333;
      }

      .score {
        color: #666;
        font-size: 0.9em;
        font-weight: bold;
      }

      /* Loading and status styles */
      .loading {
        color: #007bff;
        font-style: italic;
      }

      .error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .success {
        color: #155724;
        background-color: #d4edda;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      /* Progress indicator */
      .progress {
        width: 100%;
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Semantic Document Search Engine</h1>

      <!-- Document Upload Section -->
      <div class="section">
        <h2>üìÅ Upload Document</h2>
        <p>
          Upload text files (.txt) to add them to your searchable document
          collection.
        </p>

        <form id="uploadForm" enctype="multipart/form-data">
          <input
            type="file"
            id="fileInput"
            name="file"
            accept=".txt,.pdf,.docx"
            required
          />
          <input
            type="text"
            id="titleInput"
            name="title"
            placeholder="Document title (optional)"
          />
          <button type="submit" id="uploadButton">Upload Document</button>
        </form>

        <div id="uploadStatus"></div>
      </div>

      <!-- Search Section -->
      <div class="section">
        <h2>üîç Search Documents</h2>
        <p>
          Enter a search query to find relevant documents. The system
          understands meaning, not just exact keywords!
        </p>

        <input
          type="text"
          id="searchInput"
          placeholder="Enter your search query... (e.g., 'machine learning', 'web development')"
        />
        <button onclick="searchDocuments()" id="searchButton">Search</button>

        <div id="searchResults" class="results"></div>
      </div>

      <!-- Document Library Section -->
      <div class="section">
        <h2>üìö Document Library</h2>
        <p>
          View all documents in your collection with metadata and statistics.
        </p>

        <button onclick="listDocuments()" id="listButton">
          Show All Documents
        </button>
        <div id="documentList" class="results"></div>
      </div>

      <!-- Statistics Section -->
      <div class="section">
        <h2>üìä Statistics</h2>
        <p>View statistics about your document collection and search index.</p>

        <button onclick="getStats()" id="statsButton">Show Statistics</button>
        <div id="statsDisplay" class="results"></div>
      </div>
    </div>

    <script>
      // Utility function to show loading state
      function showLoading(elementId, button) {
        const element = document.getElementById(elementId);
        element.innerHTML = '<div class="loading">Loading...</div>';
        if (button) {
          button.disabled = true;
          button.textContent = "Loading...";
        }
      }

      // Utility function to show error message
      function showError(elementId, message, button) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="error">Error: ${message}</div>`;
        if (button) {
          button.disabled = false;
          button.textContent = button.dataset.originalText || "Try Again";
        }
      }

      // Utility function to show success message
      function showSuccess(elementId, message, button) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="success">${message}</div>`;
        if (button) {
          button.disabled = false;
          button.textContent = button.dataset.originalText || "Done";
        }
      }

      // Upload document functionality
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData();
          const fileInput = document.getElementById("fileInput");
          const titleInput = document.getElementById("titleInput");
          const uploadButton = document.getElementById("uploadButton");
          const statusDiv = document.getElementById("uploadStatus");

          // Store original button text
          uploadButton.dataset.originalText = uploadButton.textContent;

          // Validate file selection
          if (!fileInput.files[0]) {
            showError("uploadStatus", "Please select a file to upload");
            return;
          }

          // Prepare form data
          formData.append("file", fileInput.files[0]);
          if (titleInput.value.trim()) {
            formData.append("title", titleInput.value.trim());
          }

          // Show loading state
          showLoading("uploadStatus", uploadButton);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              // Success - clear form and show success message
              fileInput.value = "";
              titleInput.value = "";
              showSuccess(
                "uploadStatus",
                "Document uploaded and indexed successfully!",
                uploadButton
              );

              // Auto-clear success message after 3 seconds
              setTimeout(() => {
                statusDiv.innerHTML = "";
              }, 3000);
            } else {
              showError(
                "uploadStatus",
                result.detail || "Upload failed",
                uploadButton
              );
            }
          } catch (error) {
            showError(
              "uploadStatus",
              `Network error: ${error.message}`,
              uploadButton
            );
          }
        });

      // Search documents functionality
      async function searchDocuments() {
        const query = document.getElementById("searchInput").value.trim();
        const searchButton = document.getElementById("searchButton");
        const resultsDiv = document.getElementById("searchResults");

        // Store original button text
        searchButton.dataset.originalText = searchButton.textContent;

        if (!query) {
          showError("searchResults", "Please enter a search query");
          return;
        }

        // Show loading state
        showLoading("searchResults", searchButton);

        try {
          const response = await fetch(
            "/search?query=" + encodeURIComponent(query) + "&limit=10"
          );
          const results = await response.json();

          searchButton.disabled = false;
          searchButton.textContent = "Search";

          if (!response.ok) {
            showError("searchResults", results.detail || "Search failed");
            return;
          }

          if (results.length === 0) {
            resultsDiv.innerHTML =
              '<div class="result-item"><p>No results found for your query. Try using different keywords or upload more documents.</p></div>';
            return;
          }

          // Display search results
          let html = `<h3>Search Results (${results.length} found):</h3>`;
          results.forEach((result, index) => {
            // Truncate content for display
            const contentPreview =
              result.content.length > 200
                ? result.content.substring(0, 200) + "..."
                : result.content;

            html += `
                        <div class="result-item">
                            <h4>${result.title}</h4>
                            <p>${contentPreview}</p>
                            <div class="score">Similarity Score: ${result.similarity_score} | File: ${result.file_path}</div>
                        </div>
                    `;
          });

          resultsDiv.innerHTML = html;
        } catch (error) {
          showError(
            "searchResults",
            `Network error: ${error.message}`,
            searchButton
          );
        }
      }

      // List all documents functionality
      async function listDocuments() {
        const listButton = document.getElementById("listButton");
        const listDiv = document.getElementById("documentList");

        listButton.dataset.originalText = listButton.textContent;
        showLoading("documentList", listButton);

        try {
          const response = await fetch("/documents");
          const documents = await response.json();

          listButton.disabled = false;
          listButton.textContent = "Show All Documents";

          if (!response.ok) {
            showError(
              "documentList",
              documents.detail || "Failed to load documents"
            );
            return;
          }

          if (documents.length === 0) {
            listDiv.innerHTML =
              '<div class="result-item"><p>No documents found. Upload some documents to get started!</p></div>';
            return;
          }

          let html = `<h3>Document Library (${documents.length} documents):</h3>`;
          documents.forEach((doc, index) => {
            const uploadDate = new Date(doc.upload_date).toLocaleDateString();
            html += `
                        <div class="result-item">
                            <h4>${doc.title}</h4>
                            <p><strong>Stats:</strong> ${doc.word_count} words | ${doc.char_count} characters</p>
                            <p><strong>File:</strong> ${doc.file_type} | <strong>Uploaded:</strong> ${uploadDate}</p>
                        </div>
                    `;
          });

          listDiv.innerHTML = html;
        } catch (error) {
          showError(
            "documentList",
            `Network error: ${error.message}`,
            listButton
          );
        }
      }

      // Get statistics functionality
      async function getStats() {
        const statsButton = document.getElementById("statsButton");
        const statsDiv = document.getElementById("statsDisplay");

        statsButton.dataset.originalText = statsButton.textContent;
        showLoading("statsDisplay", statsButton);

        try {
          const response = await fetch("/stats");
          const stats = await response.json();

          statsButton.disabled = false;
          statsButton.textContent = "Show Statistics";

          if (!response.ok) {
            showError(
              "statsDisplay",
              stats.detail || "Failed to load statistics"
            );
            return;
          }

          let html = "<h3>Search Index Statistics:</h3>";
          html += `
                    <div class="result-item">
                        <p><strong>Total Documents:</strong> ${
                          stats.total_documents
                        }</p>
                        <p><strong>Total Words:</strong> ${stats.total_words.toLocaleString()}</p>
                        <p><strong>Total Characters:</strong> ${stats.total_characters.toLocaleString()}</p>
                        <p><strong>Average Words per Document:</strong> ${
                          stats.average_words_per_doc
                        }</p>
                    </div>
                `;

          statsDiv.innerHTML = html;
        } catch (error) {
          showError(
            "statsDisplay",
            `Network error: ${error.message}`,
            statsButton
          );
        }
      }

      // Allow searching with Enter key
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            searchDocuments();
          }
        });

      // Auto-focus on search input when page loads
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("searchInput").focus();
      });
    </script>
  </body>
</html>
